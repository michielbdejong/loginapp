<script language="JavaScript" type="text/javascript" src="unhosted/prng4.js"></script>
<script language="JavaScript" type="text/javascript" src="unhosted/rng.js"></script>
<script language="JavaScript" type="text/javascript" src="unhosted/rijndael.js"></script>
<script language="JavaScript" type="text/javascript" src="unhosted/sha1.js"></script>
<script language="JavaScript" type="text/javascript" src="unhosted/jsbn.js"></script>
<script language="JavaScript" type="text/javascript" src="unhosted/unhosted.js"></script>
<script>
var loggedInGuid = undefined;

//THE ACTUAL APPLICATION:
function loadPoem() {
	document.getElementById('poem').value = unhosted.get(loggedInGuid, 'poem');
}
function savePoem() {
	unhosted.set(loggedInGuid, 'poem', document.getElementById('poem').value);
}

//THE LOGIN PROCEDURE FOR EXISTING USERS:
function showApp() {
	if(typeof loggedInGuid == 'undefined') {
		document.getElementById('keyDiv').innerHTML = 'Not logged in.';
	} else {
		document.getElementById('keyDiv').innerHTML =
			'love poem: <input type="text" id="poem"><input type="button" value="save poem" onclick="savePoem();" id="savePoemButton"><br><br>'
			+'<input type="button" value="logout" onclick="logout();" id="logoutButton"/>';
		loadPoem();
	}
}
function loginWithWallet() {
	document.getElementById('loginButton').disabled = true;
	var guid = document.getElementById("login_guid").value;
	var pass = document.getElementById("login_pass").value;
	unhosted.importWallet(guid, 'grommace.com', pass);
	loggedInGuid = guid;
	showApp();
	document.getElementById('loginButton').disabled = false;
}
function logout() {
	document.getElementById('logoutButton').disabled = true;
	loggedInGuid=undefined;
	document.getElementById('logoutButton').disabled = false;
	showApp();
}

//THE REGISTRATION PROCEDURE FOR NEW USERS:
function registerStep1() {
	document.getElementById('registerButton').disabled = true;
	var guid = document.getElementById("reg_email").value;
	if(!unhosted.nodeExists(guid)) {
		alert("since your email "+guid+" does not support unhosted storage we will unhost your data to mlsn.org. that's how nice mlsn.org are. Check http://www.unhosted.org/UnhostYourself.html for ways to fix this");
		guid += ".mlsn.org";
	}
	var regCaptchaUrl = unhosted.getCaptchaUrl(guid, 'reg');
	document.getElementById("captchaDiv").innerHTML = 
	"<table><tr><td>Password:</td><td> <input type=\"text\" value=\"pwd\" id=\"reg_pass\"></td></tr>"
		+"<tr><td>Repeat:</td><td> <input type=\"text\" value=\"pwd\" id=\"reg_pass2\"></td></tr></table>"
		+"<input type=\"hidden\" value=\""+guid+"\" id=\"actualGuid\">"
		+"<img width=\"100\" src=\""+regCaptchaUrl+"\"><p> Write the letters from the image (hint: try 'asdf')"
		+"<input type=\"text\" id=\"captchaSolution\"></p>"
		+"<div id=\"captchaButtonDiv\"><input type=\"button\" value=\"submit\" onclick=\"registerStep2();\"></div>";
	document.getElementById('registerButton').disabled = false;
	document.getElementById("registerButtonDiv").innerHTML = "";
}

function registerStep2() {
	var emailForWallet = document.getElementById("reg_email").value;
	var pass = document.getElementById("reg_pass").value;
	var pass2 = document.getElementById("reg_pass2").value;
	var captchaSolution = document.getElementById("captchaSolution").value;
	var guidForUnhosted = document.getElementById("actualGuid").value;
	var regResult;
	if(pass != pass2) {
		alert('passwords don\'t match');
	} else {
		//send create command including captcha and guid. if the guid already existed, it will say 'thanks for the captcha, but please pick an app to PopShake from before your account will be activated:
		regResult = unhosted.registerWithCaptcha(guidForUnhosted, captchaSolution);
		if(regResult == "ok") {
			unhosted.exportWallet(emailForWallet, guidForUnhosted, 'grommace.com', pass);
			loggedInGuid = guidForUnhosted;
			showApp();
		} else if(regResult == "HTTP/1.1 402 Forbidden") {
			alert('try typing "asdf" for the solution of the captcha ;)');
		} else if(regResult == "pendingPopShake") {
			unhosted.exportWallet(emailForWallet, guidForUnhosted, 'grommace.com', pass);//export already, they can always find it as pending later.
			document.getElementById("captchaButtonDiv").innerHTML= "";
			document.getElementById("popShakeDiv").innerHTML=
				"Name an app you used before:<br>"
				+" <input type=\"text\" id=\"popShakeApp\" value=\"fastcars.org\">"
				+" <input type=\"submit\" id=\"popShakeButton\" value=\"Do the PopShake!\" onclick=\"registerStep3();\">";
		}
	}
}
function registerStep3() {
	//when you get here, the node has already received the entire CREATE command from you. it is just protecting the existing account. 
	//so we should walk the popshake circle in the opposite direction than we were doing.
	//the unhosted storage node should generate the popshaketoken, and put the creation on pending until any of the existing apps give it back, with their PubPass.
	var guidForUnhosted = document.getElementById('actualGuid').value;
	var emailForWallet = document.getElementById('reg_email').value;
	var existing_app = document.getElementById('popShakeApp').value;
	//var popupUrl ="http://"+existing_app+"/PopShake/?app=lovepoems.org&guid="+guidForUnhosted; - should discuss which one to pick here, emailForWallet or guidForUnhosted
	var popupUrl ="http://"+existing_app+"/PopShake/?app=lovepoems.org&guid="+emailForWallet;
	window.location = popupUrl;
}
</script>
<body onload="" bgcolor="FFAAAA">
<table border="1"><tr><td><p>

<H2>Login:</H2>
<table border="1"><tr><td>
	<table>
		<tr><td>Email:</td><td> <input type="text" value="blondie@hotmail.com" id="login_guid"/></td></tr>
		<tr><td>Password:</td><td> <input type="text" value="pwd" id="login_pass"/></td></tr>
	</table>
	<input type="button" value = 'login' onclick="loginWithWallet();" id="loginButton">
</td></tr></table>

</p></td><td><p>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

</p></td><td><p>

<H2>Register:</H2>
<table border="1"><tr><td>
	<table>
		<tr><td>Email:</td><td> <input type="text" value="blondie@hotmail.com" id="reg_email"/></td></tr>
	</table>
	<div id="captchaDiv"></div>
	<div id="popShakeDiv"></div>
	<div id="registerButtonDiv"><input type="button" value = 'register' onclick="registerStep1();" id="registerButton"/></div>
</td></tr></table>

</p></td></tr></table>


<div id="keyDiv">loading</div>
</body>
</html>
